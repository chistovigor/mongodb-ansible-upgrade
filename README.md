# mongodb-ansible-upgrade
initially created with deepseek

# MongoDB Replica Set Upgrade Automation

Ansible-—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è MongoDB Replica Set

## Requirements

Ansible 2.10+
MongoDB Replica Set –∏–∑ 3+ —É–∑–ª–æ–≤
–î–æ—Å—Ç—É–ø sudo –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö

## üîÑ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Replica Set

## –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π workflow:
1. –û–±–Ω–æ–≤–ª—è–µ—Ç **–≤—Ç–æ—Ä–∏—á–Ω—ã–µ** —É–∑–ª—ã –ø–µ—Ä–≤—ã–º–∏
2. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–Ω–∏–∂–∞–µ—Ç **–ø–µ—Ä–≤–∏—á–Ω—ã–π** —É–∑–µ–ª
3. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ** –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ Primary
- Graceful –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π (`rs.stepDown()`)
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —É–∑–ª–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞
  
### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

- `target_version`: –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä 6.0)
- `maintenance_window`: –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 02:00-04:00)
- `force_upgrade`: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (true/false)

1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `inventory.ini` –∏ `group_vars/mongodb_servers_vault.yml` - —à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–æ–ª–∏,
`group_vars/mongodb_servers.yml` - –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
3. –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
```bash

**—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ**

ansible-playbook -i inventory.ini playbooks/upgrade_replicaset.yml

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏**

ansible-playbook playbooks/upgrade_replicaset.yml \
  -i inventory/production/ \
  --ask-vault-pass \
  -e "target_version=7.0"

## usage - command sequence

–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

bash
git clone https://your-repo.git
cd mongodb-ansible-upgrade
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

## –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏:

bash
ansible-vault encrypt group_vars/mongodb_servers_vault.yml

## –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å:

bash
ansible-playbook playbooks/upgrade_replicaset.yml --ask-vault-pass

## –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª —Å –ø–∞—Ä–æ–ª–µ–º:

bash
ansible-playbook playbooks/upgrade_replicaset.yml \
  --vault-password-file .vault_pass

–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:

```bash
ansible-playbook ansible/playbooks/upgrade_replicaset.yml \
  -i ansible/inventory/production/ \
  --ask-vault-pass \
  -e "target_version=7.0"

–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ - –æ—Ç–∫–∞—Ç:

ansible-playbook playbooks/rollback.yml \
  -i inventory/production/ \
  --ask-vault-pass
```

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π
–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ MongoDB

–í–µ—Ä—Å–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ—Ä—Å–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

–¶–µ–ª–µ–≤–∞—è –≤–µ—Ä—Å–∏—è: –ó–∞–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é target_version –∏–ª–∏ –±–µ—Ä—ë—Ç—Å—è –∏–∑ group_vars/mongodb_servers.yml

–§–∞–π–ª—ã –≤–µ—Ä—Å–∏–π
–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è vars/rollback_version.yml

–≠—Ç–æ—Ç —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
```
text

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏**:
   - –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞–ø–≥—Ä–µ–π–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è MongoDB
   - –í–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `vars/rollback_version.yml`
   - –ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞:
     ```yaml
     rollback_version: "5.0.15"
     ```

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ**:
   - Secondary –Ω–æ–¥—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
   - Primary –Ω–æ–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ graceful –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
   - –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ—Ä—Å–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞, –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

3. **–û—Ç–∫–∞—Ç**:
   - –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ—Ä—Å–∏—é –∏–∑ `vars/rollback_version.yml`
   - –ù–µ —Ç—Ä–µ–±—É–µ—Ç —É–∫–∞–∑–∞–Ω–∏—è –≤–µ—Ä—Å–∏–∏ - –æ–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç –∫ –≤–µ—Ä—Å–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

### –ü—Ä–∏–º–µ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:**

```bash
ansible-playbook ansible/playbooks/upgrade_replicaset.yml \
  -i ansible/inventory/production/ \
  --ask-vault-pass \
  -e "target_version=7.0"

# –í –≤—ã–≤–æ–¥–µ –±—É–¥–µ—Ç:
# TASK [mongodb_upgrade : Show versions] ***************************************
# ok: [mongodb1] => 
#   msg: |-
#     –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MongoDB:
#     –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: 6.0.5
#     –¶–µ–ª–µ–≤–∞—è –≤–µ—Ä—Å–∏—è: 7.0
#     –í–µ—Ä—Å–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞: 6.0.5
–û—Ç–∫–∞—Ç:

ansible-playbook playbooks/rollback.yml \
  -i inventory/production/ \
  --ask-vault-pass

# –í –≤—ã–≤–æ–¥–µ –±—É–¥–µ—Ç:
# TASK [Show rollback version] *************************************************
# ok: [mongodb1] => 
#   msg: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–∫–∞—Ç –∫ –≤–µ—Ä—Å–∏–∏ 6.0.5

# –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–∂–∏–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π!)
ansible-playbook playbooks/rollback.yml -i inventory/ -e "force_rollback=true"

```

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
–ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏:

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ db.version() –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏

–í–µ—Ä—Å–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º –¥–æ—Å—Ç—É–ø–Ω–æ–º —É–∑–ª–µ

–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞:

–í–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ playbook

–§–∞–π–ª —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏

–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:

–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –æ—Ç–∫–∞—Ç–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—É –∂–µ –≤–µ—Ä—Å–∏—é

–§–∞–π–ª –≤–µ—Ä—Å–∏–∏ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—É—Å–∫–∞—Ö –∞–ø–≥—Ä–µ–π–¥–∞

–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫:

–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–¥ –æ—Ç–∫–∞—Ç–æ–º

–Ø–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Vault
–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞:

bash
ansible-vault encrypt group_vars/mongodb_servers_vault.yml
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:

bash
ansible-vault edit group_vars/mongodb_servers_vault.yml
–ó–∞–ø—É—Å–∫ –ø–ª–µ–π–±—É–∫–∞:

bash
ansible-playbook playbooks/deploy_monitoring.yml \
  --ask-vault-pass \
  -i inventory/production/
## .gitignore –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
text

# –ò—Å–∫–ª—é—á–∞–µ–º –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
*_unencrypted.yml
*.vault-password

–í—Å–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ, –∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–∏—Ö —á–µ—Ä–µ–∑ vault_* –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤ Git
–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º
–õ–µ–≥–∫—É—é —Ä–æ—Ç–∞—Ü–∏—é —Å–µ–∫—Ä–µ—Ç–æ–≤
–ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º


## –≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

–ø–æ–ª–Ω—É—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –æ—Ç–∫–∞—Ç–∞ —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤–µ—Ä—Å–∏—è–º–∏, —á—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è production-—Å—Ä–µ–¥.
–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è
–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ CI/CD
